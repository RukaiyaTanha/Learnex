{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Selection - Smart Class Performance Tracker</title>
    <link rel="stylesheet" href="{% static 'accounts/course-selection.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
<div class="container">
    <header>
        <h1>Hi {{ username }}, Choose your courses</h1>
        <p>Select your courses to unlock content and quizzes</p>
    </header>

    <div class="content-section">
        <div class="selection-panel">
            <div class="selection-group">
                <h2>Select a course</h2>
                <div class="custom-select">
                    <select id="course-select">
                        <option value="" selected disabled>Select a course</option>
                        {% for course in courses %}
                            <option value="{{ course.code }}">{{ course.name }}</option>
                        {% endfor %}
                    </select>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <button id="add-course-btn" class="start-btn">Add Course</button>
            </div>
        </div>

        <div class="courses-grid" id="coursesGrid">
        </div>

        <button id="save-courses-btn" class="start-btn">Save & Continue</button>
    </div>

    <div class="navigation-footer">
        <a href="{% url 'student_dashboard' %}" class="nav-link">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </a>
        <a href="{% url 'course_selection_page' %}" class="nav-link active">
            <i class="fas fa-book"></i>
            <span>Courses</span>
        </a>
        <a href="{% url 'selected_courses_page' %}" class="nav-link">
            <i class="fas fa-bookmark"></i>
            <span>Selected Courses</span>
        </a>
        <a href="{% url 'quiz_selection_page' %}" class="nav-link">
            <i class="fas fa-question-circle"></i>
            <span>Quiz</span>
        </a>
        <a href="#" class="nav-link">
            <i class="fas fa-cog"></i>
            <span>Settings</span>
        </a>
    </div>
</div>

<script>
const courseSelect = document.getElementById('course-select');
const addBtn = document.getElementById('add-course-btn');
const coursesGrid = document.getElementById('coursesGrid');
const saveBtn = document.getElementById('save-courses-btn');

let selectedCourses;
try {
    selectedCourses = new Set(JSON.parse('{{ user_courses_json|default:"[]"|escapejs }}'));
} catch (e) {
    console.error("Failed to parse user_courses_json:", e);
    selectedCourses = new Set();
}
function addCourseCard(code, text) {
    if (document.getElementById(code)) return; 
    const card = document.createElement('div');
    card.className = 'quiz-option-card';
    card.id = code;
    card.innerHTML = `
        <h3>${text}</h3>
        <div class="course-status unlocked"><i class="fas fa-check"></i> Unlocked</div>
        <button type="button" class="start-btn remove-btn">Remove</button>
    `;
    coursesGrid.appendChild(card);

    card.querySelector('.remove-btn').addEventListener('click', () => {
        selectedCourses.delete(code);
        card.remove();
    });

    selectedCourses.add(code);
}
function renderCourses() {
    coursesGrid.innerHTML = "";
    for (const code of selectedCourses) {
        const option = courseSelect.querySelector(`option[value="${code}"]`);
        const text = option ? option.text : code;
        const card = document.createElement('div');
        card.className = 'quiz-option-card';
        card.id = code;
        card.innerHTML = `
            <h3>${text}</h3>
            <div class="course-status unlocked"><i class="fas fa-check"></i> Unlocked</div>
            <button type="button" class="start-btn remove-btn">Remove</button>
        `;
        coursesGrid.appendChild(card);
        card.querySelector('.remove-btn').addEventListener('click', () => {
            selectedCourses.delete(code);
            card.remove();
        });
    }
}
renderCourses();

addBtn.addEventListener('click', () => {
    const code = courseSelect.value;
    if (!code) return alert("Select a course!");
    if (selectedCourses.has(code)) return alert("Already added!");
    const text = courseSelect.options[courseSelect.selectedIndex].text;
    addCourseCard(code, text);
});

saveBtn.addEventListener('click', async () => {
    const coursesArray = Array.from(selectedCourses);
    if (!coursesArray.length) return alert("Select at least one course!");

    try {
        const response = await fetch("{% url 'save_courses_api' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({ courses: coursesArray })
        });

        const data = await response.json();
        if (data.success) {
            if (Array.isArray(data.courses)) {
                selectedCourses = new Set(data.courses);
            }
            alert(data.message || "Courses saved successfully!");
            window.location.href = "{% url 'selected_courses_page' %}";
        } else {
            alert(data.message || "Something went wrong. Try again.");
        }
    } catch (err) {
        console.error(err);
        alert("Server error, try again.");
    }
});
</script>
</body>
</html>
