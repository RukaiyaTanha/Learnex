{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Post Student Marks</title>
  <link rel="stylesheet" href="{% static 'accounts/upload_student_info.css' %}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
<div class="container">
  <section class="section-student-panel">
    <header class="dashboard-header">
      <h1>Hi {{ username }}, Post Student Marks</h1>
      <p>Upload marks CSV for a semester/course/section. Uploads are saved as unpublished â€” publish when ready.</p>
    </header>

    {% if messages %}
      <div class="messages">
        {% for message in messages %}
          <div class="message {{ message.tags }}">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}

    <form method="post" enctype="multipart/form-data">
      {% csrf_token %}
      <div class="form-row">
        <div class="form-group">
          <label for="semesterSelect"><i class="fas fa-calendar-alt"></i> Semester</label>
          <select id="semesterSelect" name="semester" required>
            <option value="" disabled selected>Select Semester</option>
            {% for sem, courses in semester_courses_dict.items %}
              <option value="{{ sem }}">{{ sem }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="form-group">
          <label for="courseSelect"><i class="fas fa-book"></i> Course</label>
          <select id="courseSelect" name="course" required>
            <option value="" disabled>Select Course</option>
          </select>
        </div>

        <div class="form-group">
          <label for="sectionSelect"><i class="fas fa-users"></i> Section</label>
          <select id="sectionSelect" name="section" required>
            <option value="" disabled selected>Select Section</option>
            {% for s in section_choices %}
              <option value="{{ s }}">{{ s }}</option>
            {% endfor %}
          </select>
        </div>
      </div>

      <div class="form-group">
        <label for="marksFile"><i class="fas fa-file-csv"></i> Marks CSV</label>
        <input type="file" id="marksFile" name="marksFile" accept=".csv" required>
        <small class="muted">CSV should contain student_email, student_name and numeric columns like quiz1, quiz2, termexam etc.</small>
      </div>

      <div style="display:flex; gap:12px; align-items:center;">
        <button type="submit" class="submit-btn"><i class="fas fa-bullhorn"></i> Publish Marks</button>

        <!-- publish form: publishes marks for selected semester/course/section
        <form method="post" action="{% url 'publish_marks' %}" id="publishForm" style="display:inline;">
          {% csrf_token %}
          <input type="hidden" name="semester" id="pubSemester" value="">
          <input type="hidden" name="course" id="pubCourse" value="">
          <input type="hidden" name="section" id="pubSection" value="">
          <button type="submit" class="submit-btn" style="background:linear-gradient(90deg,#10b981,#059669);">
            <i class="fas fa-bullhorn"></i> Publish Marks
          </button>
        </form> -->
      </div>
    </form>
  </section>
  <div class="navigation-footer">
      <a href="{% url 'teacher_dashboard' %}" class="nav-link">
          <i class="fas fa-home"></i>
          <span>Home</span>
      </a>
      <a href="{% url 'teacher_published_marks_page' %}" class="nav-link">
          <i class="fas fa-users"></i>
          <span>Student Marks Info</span>
      </a>
      <a href="#" class="nav-link">
          <i class="fas fa-cog"></i>
          <span>Settings</span>
      </a>
  </div>
</div>

<script>
  const semesterSelect = document.getElementById('semesterSelect');
  const courseSelect = document.getElementById('courseSelect');
  const semesterCourses = JSON.parse('{{ semester_courses_json|escapejs }}');

  function populateCourses(semester) {
    const courses = semesterCourses[semester] || [];
    courseSelect.innerHTML = '<option value="" disabled selected>Select Course</option>';
    courses.forEach(name => {
      const opt = document.createElement('option');
      opt.value = name;
      opt.textContent = name;
      courseSelect.appendChild(opt);
    });
  }

  semesterSelect.addEventListener('change', () => {
    populateCourses(semesterSelect.value);
    document.getElementById('pubSemester').value = semesterSelect.value;
  });

  courseSelect.addEventListener('change', () => {
    document.getElementById('pubCourse').value = courseSelect.value;
  });

  document.getElementById('sectionSelect').addEventListener('change', () => {
    document.getElementById('pubSection').value = document.getElementById('sectionSelect').value;
  });

  window.addEventListener('DOMContentLoaded', () => {
    const first = semesterSelect.querySelector('option:not([disabled])');
    if (first) {
      first.selected = true;
      populateCourses(first.value);
      document.getElementById('pubSemester').value = first.value;
    }
  });
</script>
</body>
</html>
